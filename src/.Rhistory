library(haven)
library(readr)
library(tidyverse)
setwd("/Users/pedrovallocci/")
dhi_crsp_fullmerge_with_soc <- read_dta("Documents/PhD (local)/Research/By Topic/Bargaining Power/data/dhi_crsp_fullmerge_with_soc.dta")
View(dhi_crsp_fullmerge_with_soc)
source("~/Documents/PhD (local)/Research/Github/KnowledgeKRisk_10Ks/src/st4c_APanalysis_clean.R")
setwd("~/Documents/PhD (local)/Research/Github/KnowledgeKRisk_10Ks/src")
source("~/Documents/PhD (local)/Research/Github/KnowledgeKRisk_10Ks/src/st4c_APanalysis_clean.R")
summary(second_stage_wls)
latex_table
summary(second_stage_wls_nokk)
View(stoxwe_with_pfs)
pf_ret = stoxwe_with_pfs %>%
drop_na(eretw, me) %>%
group_by(yw, pf36_name) %>%
summarize(eret = sum(eretw*me, na.rm = TRUE)/sum(me, na.rm = TRUE), Mkt.RF = mean(Mkt.RF), SMB = mean(SMB), HML = mean(HML), RF = mean(RF))
kkhml_ret = stoxwe_with_pfs %>%
drop_na(topic_kk) %>%
ungroup() %>%
group_by(yw, ntile_topic_kk) %>%
summarize(eret = sum(eretw*me, na.rm = TRUE)/sum(me, na.rm = TRUE)) %>%
pivot_wider(names_from = ntile_topic_kk, names_prefix = "kk", values_from = eret) %>%
transmute(yw, kkhml = kk4-kk1)
eret_we = pf_ret %>%
inner_join(kkhml_ret, by = c("yw")) %>%
rename(eretw = eret)  %>%
drop_na() %>%
ungroup()
formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF
first_stage1 = eret_we %>%
ungroup() %>%
nest_by(pf36_name) %>%
mutate(mod = list(lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = data))) %>%
summarize(eretw = mean(data$eretw), t = length(data$eretw), tidy(mod))
get_sigmae = first_stage1 %>%
mutate(sigmae = t*std.error^2) %>%
filter(term == "(Intercept)") %>%
select(pf36_name, sigmae) %>%
drop_na()
first_stage2 = first_stage1 %>%
select(-std.error, -statistic, -p.value) %>%
pivot_wider(names_from = term, values_from = estimate) %>%
full_join(get_sigmae, by = c("pf36_name")) %>%
drop_na()
second_stage_ols = lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = first_stage2)
second_stage_wls_nokk = lm(formula3ff <- eretw ~ HML + SMB + Mkt.RF, data = first_stage2, weights = first_stage2$sigmae)
second_stage_wls = lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = first_stage2, weights = first_stage2$sigmae)
summary(second_stage_wls_nokk)
summary(second_stage_wls)
first_stage2
View(first_stage2)
View(first_stage1)
first_stage1 = eret_we %>%
ungroup() %>%
nest_by(pf36_name) %>%
mutate(mod = list(lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = data)))
first_stage1 = eret_we %>%
ungroup() %>%
nest_by(pf36_name) %>%
mutate(mod = list(lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = data))) %>%
summarize(tidy(mod))
first_stage1 = eret_we %>%
ungroup() %>%
nest_by(pf36_name) %>%
mutate(mod = list(lm(formula3ff <- eretw ~ kkhml + HML + SMB + Mkt.RF, data = data))) %>%
summarize(tidy(mod))
summary(second_stage_wls_nokk)
